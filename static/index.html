<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ReDry Proposal Builder</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'DM Sans', sans-serif; background: #f8f9fb; color: #1a1a2e; }
input, button, select { font-family: 'DM Sans', sans-serif; }
a { color: inherit; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

const C = { orange: "#E8943A", navy: "#1B2A4A", dark: "#1a1a2e", gray: "#64748b", bg: "#f8f9fb", border: "#e2e8f0" };
const API = "";

const PHD = {
  level3: { dry: "0\u201335", damp: "35\u201370", sat: "70\u201399" },
  level2: { dry: "0\u201315", damp: "15\u201340", sat: "40\u201399" },
  level1: { dry: "0", damp: "1\u201320", sat: "21\u201399" },
};

const numWord = n => ["zero","one","two","three","four","five","six","seven","eight","nine","ten"][n] || String(n);
const fmtC = v => new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(v);
const fmtN = v => new Intl.NumberFormat("en-US").format(v);
const fmtDate = s => new Date(s).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"});
const addDays = (s,d) => { const dt=new Date(s); dt.setDate(dt.getDate()+d); return fmtDate(dt); };
const propNum = s => { const d=new Date(s); return `P-${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`; };

const defaultForm = {
  clientCompany:"", clientContact:"", clientTitle:"", clientPhone:"", clientEmail:"",
  projectName:"", projectAddress:"", projectCity:"", projectState:"", projectZip:"",
  projectSection:"", wetSF:"", ratePSF:"2.00", scanCost:"4500", numScans:"4",
  scanInterval:"3", totalVents:"", proposalDate: new Date().toISOString().split("T")[0], validDays:"30"
};

function Inp({label,value,onChange,type="text",placeholder,prefix,suffix,half,third,required}) {
  const st = {flex: half?"0 0 48%":third?"0 0 31%":"1 1 100%", minWidth: third?140:half?200:0};
  return (
    <div style={st}>
      <label style={{display:"block",fontSize:12,fontWeight:600,color:C.navy,marginBottom:4,letterSpacing:0.3}}>
        {label} {required && <span style={{color:C.orange}}>*</span>}
      </label>
      <div style={{display:"flex",alignItems:"center",background:"#fff",border:`1px solid ${C.border}`,borderRadius:6,overflow:"hidden"}}>
        {prefix && <span style={{padding:"8px 0 8px 12px",color:C.gray,fontSize:14,fontWeight:500}}>{prefix}</span>}
        <input type={type} value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder}
          style={{flex:1,padding:prefix?"8px 12px 8px 4px":"8px 12px",border:"none",outline:"none",fontSize:14,fontFamily:"'DM Sans',sans-serif",color:C.dark,background:"transparent",width:"100%"}}/>
        {suffix && <span style={{padding:"8px 12px 8px 0",color:C.gray,fontSize:13}}>{suffix}</span>}
      </div>
    </div>
  );
}

function SecLabel({children}) {
  return (<div style={{marginTop:20,marginBottom:8}}>
    <div style={{fontSize:15,fontWeight:700,color:C.navy,letterSpacing:0.5,textTransform:"uppercase"}}>{children}</div>
    <div style={{height:2,width:40,background:C.orange,borderRadius:1,marginTop:4}}/>
  </div>);
}

function PHDTable({compact}) {
  const fs=compact?12:13, pad=compact?"6px 10px":"8px 14px";
  return (<table style={{width:"100%",borderCollapse:"collapse",fontSize:fs,marginTop:8}}>
    <thead><tr>{["PHD Setting","Dry","Damp","Saturated"].map(h=>
      <th key={h} style={{background:C.navy,color:"#fff",padding:pad,textAlign:h==="PHD Setting"?"left":"center",fontWeight:600,fontSize:fs-1}}>{h}</th>
    )}</tr></thead>
    <tbody>{[["Level 3",PHD.level3],["Level 2",PHD.level2],["Level 1",PHD.level1]].map(([l,v],i)=>
      <tr key={l} style={{background:i%2===0?"#f1f5f9":"#fff"}}>
        <td style={{padding:pad,fontWeight:600,color:C.navy}}>{l}</td>
        <td style={{padding:pad,textAlign:"center",color:"#16a34a"}}>{v.dry}</td>
        <td style={{padding:pad,textAlign:"center",color:C.orange}}>{v.damp}</td>
        <td style={{padding:pad,textAlign:"center",color:"#dc2626"}}>{v.sat}</td>
      </tr>
    )}</tbody>
  </table>);
}

// ‚îÄ‚îÄ‚îÄ BUILDER FORM ‚îÄ‚îÄ‚îÄ
function BuilderForm({form,setForm,ventMapFile,setVentMapFile,onPDF,onLink,loading,result}) {
  const fileRef = useRef();
  const s = k => v => setForm(f=>({...f,[k]:v}));
  const wetSF=parseFloat(form.wetSF)||0, rate=parseFloat(form.ratePSF)||0;
  const scanCost=parseFloat(form.scanCost)||0, numScans=parseInt(form.numScans)||0;
  const ventTotal=wetSF*rate, scanTotal=scanCost*numScans, total=ventTotal+scanTotal;
  const ok = form.clientCompany && form.projectName && form.projectAddress && wetSF>0;

  return (<div style={{maxWidth:780,margin:"0 auto"}}>
    <div style={{textAlign:"center",marginBottom:32}}>
      <div style={{fontSize:11,fontWeight:700,color:C.orange,letterSpacing:2,textTransform:"uppercase",marginBottom:4}}>ReDry Proposal Builder</div>
      <h1 style={{fontSize:28,fontWeight:800,color:C.navy,margin:0,fontFamily:"'Playfair Display',serif"}}>Create New Proposal</h1>
      <p style={{color:C.gray,fontSize:14,marginTop:6}}>Fill in the project details to generate a branded PDF and shareable client link.</p>
    </div>
    <div style={{background:"#fff",borderRadius:12,border:`1px solid ${C.border}`,padding:28,boxShadow:"0 1px 3px rgba(0,0,0,0.04)"}}>
      <SecLabel>Client Information</SecLabel>
      <div style={{display:"flex",flexWrap:"wrap",gap:12,marginBottom:4}}><Inp label="Company Name" value={form.clientCompany} onChange={s("clientCompany")} placeholder="L.D. Tebben Company" required/></div>
      <div style={{display:"flex",flexWrap:"wrap",gap:12,marginBottom:4}}>
        <Inp label="Contact Name" value={form.clientContact} onChange={s("clientContact")} placeholder="Justin Boren" half/>
        <Inp label="Title" value={form.clientTitle} onChange={s("clientTitle")} placeholder="Senior Technical Estimator" half/>
      </div>
      <div style={{display:"flex",flexWrap:"wrap",gap:12}}>
        <Inp label="Phone" value={form.clientPhone} onChange={s("clientPhone")} placeholder="(512) 663-9226" half/>
        <Inp label="Email" value={form.clientEmail} onChange={s("clientEmail")} placeholder="jboren@ldtebben.com" half/>
      </div>

      <SecLabel>Project Details</SecLabel>
      <div style={{display:"flex",flexWrap:"wrap",gap:12,marginBottom:4}}><Inp label="Project Name" value={form.projectName} onChange={s("projectName")} placeholder="Crockett High School" required/></div>
      <div style={{display:"flex",flexWrap:"wrap",gap:12,marginBottom:4}}><Inp label="Street Address" value={form.projectAddress} onChange={s("projectAddress")} placeholder="5601 Menchaca Rd" required/></div>
      <div style={{display:"flex",flexWrap:"wrap",gap:12,marginBottom:4}}>
        <Inp label="City" value={form.projectCity} onChange={s("projectCity")} placeholder="Austin" third/>
        <Inp label="State" value={form.projectState} onChange={s("projectState")} placeholder="TX" third/>
        <Inp label="ZIP" value={form.projectZip} onChange={s("projectZip")} placeholder="78745" third/>
      </div>
      <div style={{display:"flex",flexWrap:"wrap",gap:12}}>
        <Inp label="Section / Area" value={form.projectSection} onChange={s("projectSection")} placeholder="North Section" half/>
        <Inp label="Projected Vent Count" value={form.totalVents} onChange={s("totalVents")} placeholder="30" type="number" half/>
      </div>

      <SecLabel>Pricing</SecLabel>
      <div style={{display:"flex",flexWrap:"wrap",gap:12,marginBottom:4}}>
        <Inp label="Wet Insulation (SF)" value={form.wetSF} onChange={s("wetSF")} placeholder="11600" type="number" required third/>
        <Inp label="Rate" value={form.ratePSF} onChange={s("ratePSF")} prefix="$" suffix="/ SF" type="number" third/>
        <Inp label="Scan Cost" value={form.scanCost} onChange={s("scanCost")} prefix="$" suffix="/ scan" type="number" third/>
      </div>
      <div style={{display:"flex",flexWrap:"wrap",gap:12}}>
        <Inp label="Number of Scans" value={form.numScans} onChange={s("numScans")} type="number" third/>
        <Inp label="Scan Interval" value={form.scanInterval} onChange={s("scanInterval")} suffix="months" type="number" third/>
        <Inp label="Proposal Date" value={form.proposalDate} onChange={s("proposalDate")} type="date" third/>
      </div>

      {wetSF>0 && <div style={{marginTop:20,background:"#f8fafc",border:`1px solid ${C.border}`,borderRadius:8,padding:16}}>
        <div style={{display:"flex",justifyContent:"space-between",fontSize:13,color:C.gray,marginBottom:6}}>
          <span>Vent System Lease: {fmtN(wetSF)} SF √ó {fmtC(rate)}</span><span style={{fontWeight:600,color:C.dark}}>{fmtC(ventTotal)}</span>
        </div>
        <div style={{display:"flex",justifyContent:"space-between",fontSize:13,color:C.gray,marginBottom:8}}>
          <span>Moisture Scans: {numScans} √ó {fmtC(scanCost)}</span><span style={{fontWeight:600,color:C.dark}}>{fmtC(scanTotal)}</span>
        </div>
        <div style={{borderTop:`2px solid ${C.navy}`,paddingTop:8,display:"flex",justifyContent:"space-between"}}>
          <span style={{fontSize:14,fontWeight:700,color:C.navy}}>Contract Total</span>
          <span style={{fontSize:18,fontWeight:800,color:C.navy}}>{fmtC(total)}</span>
        </div>
      </div>}

      <SecLabel>Vent Placement Map</SecLabel>
      <div onClick={()=>fileRef.current?.click()}
        onDragOver={e=>{e.preventDefault();e.stopPropagation()}}
        onDrop={e=>{e.preventDefault();e.stopPropagation();const f=e.dataTransfer.files[0];if(f&&f.type.startsWith("image/"))setVentMapFile(f)}}
        style={{border:`2px dashed ${ventMapFile?C.orange:C.border}`,borderRadius:8,padding:24,textAlign:"center",cursor:"pointer",background:ventMapFile?"#fef7ed":"#fff",transition:"all 0.2s"}}>
        <input ref={fileRef} type="file" accept="image/*" style={{display:"none"}} onChange={e=>e.target.files[0]&&setVentMapFile(e.target.files[0])}/>
        {ventMapFile
          ? <div><div style={{fontSize:13,fontWeight:600,color:C.orange}}>‚úì {ventMapFile.name}</div><div style={{fontSize:12,color:C.gray,marginTop:4}}>Click or drop to replace</div></div>
          : <div><div style={{fontSize:28,marginBottom:4}}>üìé</div><div style={{fontSize:13,fontWeight:600,color:C.navy}}>Drop vent placement map here</div><div style={{fontSize:12,color:C.gray,marginTop:4}}>or click to browse (PNG, JPG)</div></div>}
      </div>
    </div>

    <div style={{display:"flex",gap:12,marginTop:20}}>
      <button onClick={onPDF} disabled={!ok||loading} style={{flex:1,padding:"14px 0",border:"none",borderRadius:8,background:ok&&!loading?C.navy:"#cbd5e1",color:"#fff",fontSize:15,fontWeight:700,cursor:ok&&!loading?"pointer":"not-allowed",letterSpacing:0.5,transition:"all 0.2s"}}>
        {loading==="pdf"?"Generating PDF...":"‚¨á Download PDF"}
      </button>
      <button onClick={onLink} disabled={!ok||loading} style={{flex:1,padding:"14px 0",border:"none",borderRadius:8,background:ok&&!loading?C.orange:"#cbd5e1",color:"#fff",fontSize:15,fontWeight:700,cursor:ok&&!loading?"pointer":"not-allowed",letterSpacing:0.5,transition:"all 0.2s"}}>
        {loading==="link"?"Creating Link...":"üîó Create Client Link"}
      </button>
    </div>

    {result && <div style={{marginTop:16,padding:16,background:"#f0fdf4",border:"1px solid #bbf7d0",borderRadius:8}}>
      {result.type==="pdf" && <div style={{fontSize:14,color:"#15803d",fontWeight:600}}>‚úì PDF downloaded successfully!</div>}
      {result.type==="link" && <div>
        <div style={{fontSize:14,color:"#15803d",fontWeight:600,marginBottom:8}}>‚úì Client proposal link created!</div>
        <div style={{display:"flex",gap:8,alignItems:"center"}}>
          <input readOnly value={`${window.location.origin}${result.clientUrl}`}
            style={{flex:1,padding:"8px 12px",border:`1px solid ${C.border}`,borderRadius:6,fontSize:13,fontFamily:"monospace",color:C.dark,background:"#fff"}}
            onClick={e=>e.target.select()}/>
          <button onClick={()=>navigator.clipboard.writeText(`${window.location.origin}${result.clientUrl}`)}
            style={{padding:"8px 16px",border:`1px solid ${C.border}`,borderRadius:6,background:"#fff",fontSize:13,fontWeight:600,cursor:"pointer",color:C.navy,whiteSpace:"nowrap"}}>Copy</button>
        </div>
        <div style={{fontSize:12,color:C.gray,marginTop:6}}>Share this link with your client. They can review and accept the proposal online.
          <a href={result.clientUrl} target="_blank" rel="noopener" style={{color:C.orange,marginLeft:6,fontWeight:600}}>Preview ‚Üí</a>
        </div>
      </div>}
    </div>}
  </div>);
}

// ‚îÄ‚îÄ‚îÄ CLIENT PROPOSAL VIEW ‚îÄ‚îÄ‚îÄ
function ClientView({form, ventMapUrl, proposalId, onBack}) {
  const [sigName,setSigName]=useState(""), [sigDate,setSigDate]=useState("");
  const [accepted,setAccepted]=useState(false), [submitting,setSubmitting]=useState(false);

  const wetSF=parseFloat(form.wetSF)||0, rate=parseFloat(form.ratePSF)||0;
  const scanCost=parseFloat(form.scanCost)||0, numScans=parseInt(form.numScans)||0;
  const ventTotal=wetSF*rate, scanTotal=scanCost*numScans, total=ventTotal+scanTotal;
  const deposit=ventTotal*0.5, balance=ventTotal-deposit;
  const pn=propNum(form.proposalDate), vt=addDays(form.proposalDate,parseInt(form.validDays)||30);
  const addr=[form.projectAddress,[form.projectCity,form.projectState].filter(Boolean).join(", "),form.projectZip].filter(Boolean).join(", ");
  const interval=form.scanInterval||"3";

  const doAccept = async()=>{
    if(!sigName||!sigDate)return;
    setSubmitting(true);
    try{
      if(proposalId) await fetch(`${API}/api/proposal/${proposalId}/accept`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:sigName,date:sigDate})});
      setAccepted(true);
    }catch(e){setAccepted(true);}
    setSubmitting(false);
  };

  const SH=(n,t)=>(<div style={{marginTop:36,marginBottom:12}}><h2 style={{fontSize:17,fontWeight:800,color:C.navy,margin:0,fontFamily:"'Playfair Display',serif"}}>{n}. {t}</h2><div style={{height:2,width:50,background:C.orange,marginTop:6}}/></div>);
  const P=({children})=>(<p style={{fontSize:14,lineHeight:1.7,color:"#374151",margin:"8px 0",textAlign:"justify"}}>{children}</p>);
  const B=({html})=>(<div style={{display:"flex",gap:10,marginBottom:6,fontSize:14,lineHeight:1.65,color:"#374151"}}><span style={{color:C.orange,fontWeight:700,flexShrink:0}}>‚Ä¢</span><span dangerouslySetInnerHTML={{__html:html}}/></div>);
  const Sub=({t})=>(<h3 style={{fontSize:14,fontWeight:700,color:C.navy,margin:"16px 0 8px"}}>{t}</h3>);

  if(accepted) return (
    <div style={{minHeight:"100vh",background:C.bg,display:"flex",alignItems:"center",justifyContent:"center"}}>
      <div style={{textAlign:"center",maxWidth:500,padding:40}}>
        <div style={{width:72,height:72,borderRadius:"50%",background:"#dcfce7",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 20px",fontSize:32}}>‚úì</div>
        <h1 style={{fontSize:26,fontWeight:800,color:C.navy,fontFamily:"'Playfair Display',serif",marginBottom:8}}>Proposal Accepted</h1>
        <p style={{color:C.gray,fontSize:15,lineHeight:1.6}}>Thank you. Your signed acceptance has been recorded. The ReDry team will be in touch to coordinate next steps.</p>
        <div style={{marginTop:24,padding:16,background:"#fff",borderRadius:8,border:`1px solid ${C.border}`,fontSize:13,color:C.gray}}>
          <div>Signed by: <strong style={{color:C.dark}}>{sigName}</strong></div>
          <div>Date: <strong style={{color:C.dark}}>{sigDate}</strong></div>
          <div>Proposal: <strong style={{color:C.dark}}>{pn}</strong></div>
        </div>
        {proposalId && <a href={`${API}/api/proposal/${proposalId}/pdf`} target="_blank" rel="noopener" style={{display:"inline-block",marginTop:16,padding:"10px 24px",background:C.navy,color:"#fff",borderRadius:6,fontSize:13,fontWeight:600,textDecoration:"none"}}>Download PDF Copy</a>}
        {onBack && <button onClick={onBack} style={{display:"block",margin:"12px auto 0",padding:"10px 24px",border:`1px solid ${C.border}`,borderRadius:6,background:"#fff",color:C.navy,fontSize:13,fontWeight:600,cursor:"pointer"}}>‚Üê Back to Builder</button>}
      </div>
    </div>
  );

  return (<div style={{minHeight:"100vh",background:C.bg}}>
    <div style={{background:C.navy,padding:"10px 0"}}>
      <div style={{maxWidth:820,margin:"0 auto",padding:"0 20px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
        <span style={{color:"#fff",fontSize:13,fontWeight:600,letterSpacing:1}}>RE<span style={{color:C.orange}}>DRY</span></span>
        <div style={{display:"flex",gap:8}}>
          {proposalId && <a href={`${API}/api/proposal/${proposalId}/pdf`} target="_blank" rel="noopener" style={{background:"rgba(255,255,255,0.1)",border:"1px solid rgba(255,255,255,0.2)",color:"#fff",padding:"5px 14px",borderRadius:4,fontSize:12,textDecoration:"none"}}>‚¨á PDF</a>}
          {onBack && <button onClick={onBack} style={{background:"rgba(255,255,255,0.1)",border:"1px solid rgba(255,255,255,0.2)",color:"#fff",padding:"5px 14px",borderRadius:4,fontSize:12,cursor:"pointer"}}>‚Üê Builder</button>}
        </div>
      </div>
    </div>
    <div style={{maxWidth:820,margin:"0 auto",padding:"32px 20px 60px"}}>
      {/* Header */}
      <div style={{background:"#fff",borderRadius:12,border:`1px solid ${C.border}`,overflow:"hidden",marginBottom:24}}>
        <div style={{height:4,background:C.orange}}/>
        <div style={{padding:"28px 32px"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:16}}>
            <div>
              <div style={{fontSize:11,fontWeight:700,color:C.orange,letterSpacing:2,textTransform:"uppercase",marginBottom:6}}>Proposal</div>
              <h1 style={{fontSize:26,fontWeight:800,color:C.navy,margin:0,fontFamily:"'Playfair Display',serif"}}>{form.projectName||"Project"}</h1>
              <div style={{fontSize:14,color:C.gray,marginTop:4}}>{addr}</div>
              {form.projectSection && <div style={{fontSize:14,color:C.gray}}>{form.projectSection}</div>}
            </div>
            <div style={{textAlign:"right",fontSize:13,color:C.gray,lineHeight:1.7}}><div>{pn}</div><div>{fmtDate(form.proposalDate)}</div><div>Valid through {vt}</div></div>
          </div>
          <div style={{display:"flex",gap:32,marginTop:24,paddingTop:20,borderTop:`1px solid ${C.border}`,flexWrap:"wrap"}}>
            <div style={{flex:1,minWidth:200}}>
              <div style={{fontSize:10,fontWeight:700,color:C.orange,letterSpacing:1.5,textTransform:"uppercase",marginBottom:6}}>From</div>
              <div style={{fontSize:14,color:C.dark,lineHeight:1.7}}><strong>ReDry, LLC</strong><br/>Adam Capps, Founder<br/>865.771.3848<br/>adam@re-dry.com</div>
            </div>
            <div style={{flex:1,minWidth:200}}>
              <div style={{fontSize:10,fontWeight:700,color:C.orange,letterSpacing:1.5,textTransform:"uppercase",marginBottom:6}}>To</div>
              <div style={{fontSize:14,color:C.dark,lineHeight:1.7}}>
                <strong>{form.clientCompany||"‚Äî"}</strong>
                {form.clientContact && <><br/>{form.clientContact}</>}
                {form.clientTitle && <><br/>{form.clientTitle}</>}
                {form.clientPhone && <><br/>{form.clientPhone}</>}
                {form.clientEmail && <><br/>{form.clientEmail}</>}
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Body */}
      <div style={{background:"#fff",borderRadius:12,border:`1px solid ${C.border}`,padding:"28px 32px",marginBottom:24}}>
        {SH(1,"Project Overview")}
        <P>ReDry, LLC is the manufacturer and lessor of the ReDry 2-Way Vent System, a proprietary solar-powered drying system designed to remove trapped moisture from commercial roof insulation without membrane removal or tear-off. This proposal covers the lease of the ReDry Vent System and associated performance monitoring services for the {form.projectSection||"designated area"} of {form.projectName}, located at {addr}.</P>
        <P>A Roof MRI moisture survey identified approximately <strong>{fmtN(wetSF)} square feet</strong> of wet insulation within the project area. ReDry has engineered a vent Placement Map specific to this section based on the survey data{form.totalVents?<>, calling for an estimated <strong>{form.totalVents} vents</strong></>:""}. The Placement Map defines the exact quantity and positioning of all vents and is provided to the roofing contractor prior to installation.</P>
        <P>The roofing contractor is responsible for installing the 2-Way Vents per the ReDry Installation Specification. Following installation, ReDry will attach its proprietary ReDry Vent heads to the installed 2-Way Vents, confirm proper placement, and conduct periodic moisture scans to monitor drying progress and verify system performance.</P>

        {SH(2,"Scope of Work")}
        <Sub t="2.1 Vent System Furnishing and Commissioning"/>
        <B html="ReDry will furnish all ReDry 2-Way Vents and ReDry Vent heads per the engineered Placement Map."/>
        <B html="ReDry will provide the Installation Specification (SPEC-VENT-2026-01, Rev. A) and Placement Map to the roofing contractor."/>
        <B html="The <strong>roofing contractor</strong> is solely responsible for installing and bonding the 2-Way Vents to the roof membrane per the Installation Specification. ReDry is not responsible for the attachment of the 2-Way Vents to the roof surface."/>
        <B html="Following 2-Way Vent installation, ReDry will attach the proprietary ReDry Vent heads to each installed 2-Way Vent and confirm that all vents are properly positioned over the cored holes per the Placement Map."/>
        <B html="ReDry will complete photo documentation per specification requirements for warranty activation."/>

        <Sub t="2.2 Moisture Monitoring Program"/>
        <B html={`ReDry will perform <strong>${numScans} (${numWord(numScans)}) moisture scans</strong> at approximately <strong>${interval}-month intervals</strong> following installation.`}/>
        <B html="Each scan includes a full moisture survey of the treated area using Roof MRI technology and a written report documenting moisture levels and drying progress."/>
        <B html="Scan reports will be delivered to the client within a reasonable timeframe following each survey."/>
        <B html={`A minimum of ${numScans} scans is required under this agreement regardless of drying timeline.`}/>

        <Sub t="2.3 Vent Retrieval and Performance Criteria"/>
        <P>The ReDry Vents remain the property of ReDry, LLC throughout the lease period. ReDry will retrieve the vent heads once the insulation in the area served by each vent is confirmed to have reached an acceptable moisture reading as measured by the Roof MRI PHD (Precise Hydrology Detection) scale.</P>
        <PHDTable compact/>
        <div style={{marginTop:10}}/>
        <P>Vents serving areas that have reached the "Dry" threshold on the applicable PHD setting will be retrieved by ReDry at the next scheduled site visit. Vents serving areas that remain in the "Damp" or "Saturated" range will remain in place and continue operating until acceptable readings are achieved.</P>

        <Sub t="2.4 Exclusions"/>
        <B html="Installation and adhesive bonding of the 2-Way Vents to the roof membrane (by roofing contractor)."/>
        <B html="Coring of the roof membrane and insulation (by roofing contractor per ReDry Installation Specification)."/>
        <B html="Roof membrane repair, replacement, or coating (by others)."/>
        <B html="Structural deck repair or modification."/>
        <B html="Access provisions, barricading, or traffic control (by others unless otherwise agreed)."/>
        <B html={`Any work beyond the ${form.projectSection||"designated"} boundary identified on the Placement Map.`}/>

        {SH(3,"Pricing")}
        <table style={{width:"100%",borderCollapse:"collapse",fontSize:14,marginTop:12}}>
          <thead><tr>{["Description","Quantity","Unit Rate","Total"].map((h,i)=>
            <th key={h} style={{background:C.navy,color:"#fff",padding:"10px 14px",textAlign:i>1?"right":"left",fontWeight:600,fontSize:13}}>{h}</th>
          )}</tr></thead>
          <tbody>
            <tr style={{background:"#f1f5f9"}}><td style={{padding:"10px 14px"}}>ReDry 2-Way Vent System Lease and Commissioning</td><td style={{padding:"10px 14px"}}>{fmtN(wetSF)} SF</td><td style={{padding:"10px 14px",textAlign:"right"}}>{fmtC(rate)} / SF</td><td style={{padding:"10px 14px",textAlign:"right",fontWeight:600}}>{fmtC(ventTotal)}</td></tr>
            <tr><td style={{padding:"10px 14px"}}>Moisture Monitoring Scan</td><td style={{padding:"10px 14px"}}>{numScans} scans</td><td style={{padding:"10px 14px",textAlign:"right"}}>{fmtC(scanCost)} / scan</td><td style={{padding:"10px 14px",textAlign:"right",fontWeight:600}}>{fmtC(scanTotal)}</td></tr>
            <tr style={{borderTop:`2px solid ${C.navy}`,background:"#f1f5f9"}}><td colSpan={2}/><td style={{padding:"12px 14px",textAlign:"right",fontWeight:800,color:C.navy}}>CONTRACT TOTAL</td><td style={{padding:"12px 14px",textAlign:"right",fontWeight:800,color:C.navy,fontSize:16}}>{fmtC(total)}</td></tr>
          </tbody>
        </table>

        {SH(4,"Payment Terms")}
        <Sub t="4.1 Vent System Lease and Commissioning"/>
        <P>A deposit of <strong>fifty percent (50%)</strong> of the Vent System Lease and Commissioning total ({fmtC(deposit)}) is due upon execution of this agreement. The remaining <strong>fifty percent (50%)</strong> ({fmtC(balance)}) is due within <strong>thirty (30) days</strong> of completed installation.</P>
        <Sub t="4.2 Moisture Monitoring Scans"/>
        <P>Each moisture scan ({fmtC(scanCost)} per scan) shall be invoiced individually upon delivery of the scan report. Payment is due within <strong>fifteen (15) days</strong> of receipt of the report. All {numScans} scans are guaranteed under this agreement and are non-cancelable.</P>

        <table style={{width:"100%",borderCollapse:"collapse",fontSize:13,marginTop:12}}>
          <thead><tr>{["Payment","Amount","Due"].map((h,i)=><th key={h} style={{background:C.navy,color:"#fff",padding:"8px 14px",textAlign:i===1?"right":"left",fontWeight:600}}>{h}</th>)}</tr></thead>
          <tbody>{[
            ["Deposit (50% of Vent System Lease)",fmtC(deposit),"Upon contract execution"],
            ["Balance (50% of Vent System Lease)",fmtC(balance),"Net 30 from installation completion"],
            ...Array.from({length:numScans},(_,i)=>[`Moisture Scan ${i+1} of ${numScans}`,fmtC(scanCost),"Net 15 from report delivery"])
          ].map((r,i)=><tr key={i} style={{background:i%2===0?"#f1f5f9":"#fff"}}><td style={{padding:"8px 14px"}}>{r[0]}</td><td style={{padding:"8px 14px",textAlign:"right",fontWeight:600}}>{r[1]}</td><td style={{padding:"8px 14px"}}>{r[2]}</td></tr>)}</tbody>
        </table>

        {SH(5,"General Conditions")}
        {[
          ["5.1 Relationship of Parties","ReDry is the manufacturer and lessor of the ReDry Vent System and is not a roofing contractor or subcontractor. ReDry's role is limited to furnishing the vent system, engineering the Placement Map, attaching the ReDry Vent heads, confirming vent placement, and providing ongoing moisture monitoring services."],
          ["5.2 Roofing Contractor Responsibilities","The roofing contractor engaged by the client or general contractor is solely responsible for installing and bonding the 2-Way Vents to the roof membrane in accordance with the ReDry Installation Specification (SPEC-VENT-2026-01, Rev. A). This includes all coring, adhesive application, membrane flash-in, and related roofing work. ReDry assumes no liability for the quality or workmanship of the roofing contractor's installation."],
          ["5.3 Installation Specification","All 2-Way Vent installation work shall be performed by the roofing contractor in accordance with ReDry Vent System Installation Specification SPEC-VENT-2026-01 (Rev. A). A copy of the specification will be provided to the roofing contractor and is incorporated herein by reference."],
          ["5.4 Placement Map","The ReDry Placement Map is a controlled engineering document generated from project-specific moisture survey data. The Placement Map shall not be modified by the roofing contractor or any other party without prior written authorization from ReDry."],
          ["5.5 Warranty","System warranty activation requires complete photo documentation, a passed QC inspection per the installation specification, and installation by a qualified roofing contractor. Warranty terms and coverage details are provided under separate cover upon request."],
          ["5.6 Equipment Ownership and Retrieval",'All ReDry Vent heads furnished under this agreement remain the sole property of ReDry, LLC throughout the lease period. The client shall not remove, relocate, or tamper with the ReDry Vents without prior written authorization. ReDry will retrieve the vent heads once the served area reaches an acceptable "Dry" reading on the PHD scale as described in Section 2.3. Upon retrieval, the roofing contractor or client is responsible for sealing the remaining 2-Way Vent penetrations per standard roofing practice.'],
          ["5.7 Access and Coordination","The client or general contractor shall provide safe, unobstructed access to the roof area during ReDry's commissioning visit and each scheduled moisture scan. Scheduling will be coordinated with the client to minimize disruption to building operations."],
          ["5.8 Weather Delays","Installation of 2-Way Vents by the roofing contractor requires dry conditions per adhesive manufacturer specifications. ReDry's commissioning visit will be scheduled following completion of the contractor's installation. In the event of weather delays, the project schedule will be adjusted accordingly at no additional cost."],
          ["5.9 Proposal Validity",`This proposal is valid for thirty (30) days from the date of issue (${vt}). Pricing is subject to revision after that date.`],
        ].map(([t,x])=><p key={t} style={{fontSize:14,lineHeight:1.7,color:"#374151",margin:"10px 0",textAlign:"justify"}}><strong style={{color:C.navy}}>{t}.</strong>&nbsp;&nbsp;{x}</p>)}
      </div>

      {/* Vent Map */}
      {ventMapUrl && <div style={{background:"#fff",borderRadius:12,border:`1px solid ${C.border}`,padding:"28px 32px",marginBottom:24}}>
        <h2 style={{fontSize:17,fontWeight:800,color:C.navy,margin:"0 0 4px",fontFamily:"'Playfair Display',serif"}}>Exhibit A: Vent Placement Map</h2>
        <div style={{height:2,width:50,background:C.orange,marginBottom:16}}/>
        <div style={{fontSize:14,color:C.gray,marginBottom:12}}>{form.projectName} | {addr} | {form.projectSection}</div>
        <img src={ventMapUrl} alt="Vent Placement Map" style={{width:"100%",borderRadius:8,border:`1px solid ${C.border}`}}/>
        <div style={{fontSize:12,color:C.gray,marginTop:8}}>Heat map color key: Green = dry, Yellow = moderate moisture, Orange = elevated moisture, Red = saturated.</div>
      </div>}

      {/* Acceptance */}
      <div style={{background:"#fff",borderRadius:12,border:`2px solid ${C.orange}`,padding:"28px 32px"}}>
        <h2 style={{fontSize:17,fontWeight:800,color:C.navy,margin:"0 0 4px",fontFamily:"'Playfair Display',serif"}}>Acceptance</h2>
        <div style={{height:2,width:50,background:C.orange,marginBottom:16}}/>
        <P>By signing below, the authorized representative of the client accepts this proposal and the terms described herein. This document constitutes a binding agreement between the parties upon execution.</P>
        <div style={{display:"flex",gap:16,marginTop:20,flexWrap:"wrap"}}>
          <div style={{flex:1,minWidth:200}}>
            <label style={{display:"block",fontSize:12,fontWeight:600,color:C.navy,marginBottom:4}}>Full Name / Title</label>
            <input value={sigName} onChange={e=>setSigName(e.target.value)} placeholder="Jane Smith, VP of Operations" style={{width:"100%",padding:"10px 14px",border:`1px solid ${C.border}`,borderRadius:6,fontSize:14,color:C.dark,outline:"none",boxSizing:"border-box"}}/>
          </div>
          <div style={{flex:1,minWidth:200}}>
            <label style={{display:"block",fontSize:12,fontWeight:600,color:C.navy,marginBottom:4}}>Date</label>
            <input type="date" value={sigDate} onChange={e=>setSigDate(e.target.value)} style={{width:"100%",padding:"10px 14px",border:`1px solid ${C.border}`,borderRadius:6,fontSize:14,color:C.dark,outline:"none",boxSizing:"border-box"}}/>
          </div>
        </div>
        <button onClick={doAccept} disabled={!sigName||!sigDate||submitting} style={{display:"block",width:"100%",marginTop:20,padding:"14px 0",border:"none",borderRadius:8,background:sigName&&sigDate&&!submitting?C.orange:"#cbd5e1",color:"#fff",fontSize:15,fontWeight:700,cursor:sigName&&sigDate&&!submitting?"pointer":"not-allowed"}}>
          {submitting?"Submitting...":"Accept Proposal"}
        </button>
      </div>
    </div>
  </div>);
}

// ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ
function App() {
  const [view,setView] = useState("loading");
  const [form,setForm] = useState(defaultForm);
  const [ventMapFile,setVentMapFile] = useState(null);
  const [ventMapUrl,setVentMapUrl] = useState(null);
  const [loading,setLoading] = useState(null);
  const [result,setResult] = useState(null);
  const [proposalId,setProposalId] = useState(null);

  // Check if this is a client proposal URL
  useEffect(()=>{
    const path = window.location.pathname;
    const match = path.match(/^\/proposal\/([a-f0-9]+)$/);
    if(match) {
      const id = match[1];
      setProposalId(id);
      fetch(`${API}/api/proposal/${id}`).then(r=>r.json()).then(cfg=>{
        const ventFile = cfg._ventMapFilename;
        delete cfg._ventMapFilename; delete cfg._createdAt;
        setForm(f=>({...f,...cfg}));
        if(ventFile) setVentMapUrl(`${API}/api/proposal/${id}/ventmap`);
        setView("client");
      }).catch(()=>setView("form"));
    } else {
      setView("form");
    }
  },[]);

  useEffect(()=>{
    if(ventMapFile){const u=URL.createObjectURL(ventMapFile);setVentMapUrl(u);return()=>URL.revokeObjectURL(u);}
  },[ventMapFile]);

  const buildFD=()=>{const fd=new FormData();fd.append("config",JSON.stringify(form));if(ventMapFile)fd.append("ventMap",ventMapFile);return fd;};

  const doPDF=async()=>{
    setLoading("pdf");setResult(null);
    try{
      const r=await fetch(`${API}/api/generate-pdf`,{method:"POST",body:buildFD()});
      if(!r.ok)throw new Error("fail");
      const b=await r.blob(),u=URL.createObjectURL(b),a=document.createElement("a");
      a.href=u;a.download=`ReDry_Proposal_${form.projectName.replace(/\s+/g,"_")}_${form.projectSection.replace(/\s+/g,"_")}.pdf`;
      a.click();URL.revokeObjectURL(u);setResult({type:"pdf"});
    }catch(e){alert("Failed to generate PDF. Make sure the server is running.");}
    setLoading(null);
  };

  const doLink=async()=>{
    setLoading("link");setResult(null);
    try{
      const r=await fetch(`${API}/api/generate-proposal-link`,{method:"POST",body:buildFD()});
      if(!r.ok)throw new Error("fail");
      const d=await r.json();setResult({type:"link",...d});setProposalId(d.proposalId);
    }catch(e){alert("Failed to create link. Make sure the server is running.");}
    setLoading(null);
  };

  if(view==="loading") return <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",color:C.gray}}>Loading...</div>;
  if(view==="client") return <ClientView form={form} ventMapUrl={ventMapUrl} proposalId={proposalId} onBack={null}/>;
  return (<div style={{padding:"40px 20px"}}><BuilderForm form={form} setForm={setForm} ventMapFile={ventMapFile} setVentMapFile={setVentMapFile} onPDF={doPDF} onLink={doLink} loading={loading} result={result}/></div>);
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
